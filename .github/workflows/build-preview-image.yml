# Build frontend (or other services) and push to GitHub Container Registry (ghcr.io).
# Free for public images â€” use this image in mirrord preview to avoid GCP Artifact Registry.
# Trigger: push to any branch, or "Run workflow" in Actions tab.
name: Build Preview Image (ghcr.io)

on:
  push:
    branches: ['**']
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to build'
        required: true
        default: 'frontend'
        type: choice
        options:
          - frontend
          - catalogue
          - inventory
          - checkout
          - order
          - order-processor

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Resolve service path
        id: service
        run: |
          SVC="${{ github.event.inputs.service }}"
          [ -z "$SVC" ] && SVC=frontend
          case "$SVC" in
            frontend)   PATH="frontend" ;;
            catalogue)  PATH="services/catalogue" ;;
            inventory)  PATH="services/inventory" ;;
            checkout)   PATH="services/checkout" ;;
            order)      PATH="services/order" ;;
            order-processor) PATH="services/order-processor" ;;
            *) PATH="frontend" ;;
          esac
          echo "path=$PATH" >> $GITHUB_OUTPUT
          echo "name=$SVC" >> $GITHUB_OUTPUT

      - name: Build and push to ghcr.io
        run: |
          SVC="${{ steps.service.outputs.name }}"
          SVC_PATH="${{ steps.service.outputs.path }}"
          # ghcr.io/OWNER/REPO-NAME:tag (lowercase, no extra slashes)
          IMAGE="ghcr.io/${{ github.repository_owner }}/metalmart-${SVC}:preview"
          IMAGE=$(echo "$IMAGE" | tr '[:upper:]' '[:lower:]')
          echo "Built image: $IMAGE"
          docker buildx build \
            --platform linux/amd64 \
            --tag "$IMAGE" \
            --push \
            $([ "$SVC" = "frontend" ] && echo "--build-arg VITE_PREVIEW_ENV=true") \
            "$SVC_PATH/"
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV

      - name: Output image for mirrord preview
        run: |
          echo "Use this image in mirrord preview:"
          echo "  mirrord preview start -f .mirrord/preview-frontend.json -i $IMAGE"
