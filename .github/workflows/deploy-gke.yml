name: Build and Deploy to GKE

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual trigger

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GKE_CLUSTER: metalmart-cluster
  GKE_ZONE: us-central1-a
  AR_LOCATION: us
  AR_REPOSITORY: metalmart

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker $AR_LOCATION-docker.pkg.dev --quiet

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Build and push catalogue
        run: |
          docker build -t $AR_LOCATION-docker.pkg.dev/$GCP_PROJECT_ID/$AR_REPOSITORY/catalogue:latest services/catalogue/
          docker push $AR_LOCATION-docker.pkg.dev/$GCP_PROJECT_ID/$AR_REPOSITORY/catalogue:latest

      - name: Build and push inventory
        run: |
          docker build -t $AR_LOCATION-docker.pkg.dev/$GCP_PROJECT_ID/$AR_REPOSITORY/inventory:latest services/inventory/
          docker push $AR_LOCATION-docker.pkg.dev/$GCP_PROJECT_ID/$AR_REPOSITORY/inventory:latest

      - name: Build and push checkout
        run: |
          docker build -t $AR_LOCATION-docker.pkg.dev/$GCP_PROJECT_ID/$AR_REPOSITORY/checkout:latest services/checkout/
          docker push $AR_LOCATION-docker.pkg.dev/$GCP_PROJECT_ID/$AR_REPOSITORY/checkout:latest

      - name: Build and push order
        run: |
          docker build -t $AR_LOCATION-docker.pkg.dev/$GCP_PROJECT_ID/$AR_REPOSITORY/order:latest services/order/
          docker push $AR_LOCATION-docker.pkg.dev/$GCP_PROJECT_ID/$AR_REPOSITORY/order:latest

      - name: Build and push order-processor
        run: |
          docker build -t $AR_LOCATION-docker.pkg.dev/$GCP_PROJECT_ID/$AR_REPOSITORY/order-processor:latest services/order-processor/
          docker push $AR_LOCATION-docker.pkg.dev/$GCP_PROJECT_ID/$AR_REPOSITORY/order-processor:latest

      - name: Build and push frontend
        run: |
          docker build -t $AR_LOCATION-docker.pkg.dev/$GCP_PROJECT_ID/$AR_REPOSITORY/frontend:latest frontend/
          docker push $AR_LOCATION-docker.pkg.dev/$GCP_PROJECT_ID/$AR_REPOSITORY/frontend:latest

      - name: Update kustomization with project ID
        run: |
          if grep -q "PROJECT_ID" k8s/overlays/gke/kustomization.yaml; then
            sed -i "s/PROJECT_ID/$GCP_PROJECT_ID/g" k8s/overlays/gke/kustomization.yaml
            echo "✅ Updated kustomization.yaml with project ID"
          else
            echo "⚠️  PROJECT_ID already replaced or not found, skipping"
          fi

      - name: Commit kustomization changes
        if: env.GCP_PROJECT_ID != ''
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add k8s/overlays/gke/kustomization.yaml || true
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update GKE kustomization with project ID [skip ci]" || true
            git push || true
          fi

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Install gke-gcloud-auth-plugin
        run: |
          gcloud components install gke-gcloud-auth-plugin --quiet

      - name: Configure kubectl
        run: |
          gcloud container clusters get-credentials $GKE_CLUSTER \
            --zone $GKE_ZONE \
            --project $GCP_PROJECT_ID || {
              echo "❌ Failed to get cluster credentials"
              echo "Make sure cluster '$GKE_CLUSTER' exists in zone '$GKE_ZONE'"
              exit 1
            }

      - name: Deploy infrastructure
        run: |
          kubectl apply -f k8s/base/namespace.yaml
          kubectl apply -f k8s/base/infrastructure/secrets.yaml
          kubectl apply -f k8s/base/infrastructure/postgres.yaml
          kubectl apply -f k8s/base/infrastructure/kafka.yaml

      - name: Wait for infrastructure
        run: |
          kubectl wait --for=condition=ready pod -l app=postgres -n metalmart --timeout=180s || true
          kubectl wait --for=condition=ready pod -l app=zookeeper -n metalmart --timeout=180s || true
          kubectl wait --for=condition=ready pod -l app=kafka -n metalmart --timeout=180s || true

      - name: Update kustomization with project ID (deploy job)
        run: |
          if grep -q "PROJECT_ID" k8s/overlays/gke/kustomization.yaml; then
            sed -i "s/PROJECT_ID/$GCP_PROJECT_ID/g" k8s/overlays/gke/kustomization.yaml
          fi

      - name: Deploy application services
        run: |
          kubectl kustomize k8s/overlays/gke | kubectl apply -f - || {
            echo "❌ Failed to deploy services"
            echo "Checking kustomization..."
            kubectl kustomize k8s/overlays/gke
            exit 1
          }

      - name: Enable demo mode
        run: |
          kubectl set env deployment/order-processor -n metalmart DEMO_MODE=true || true

      - name: Seed inventory
        run: |
          sleep 10
          CATALOGUE_POD=$(kubectl get pod -n metalmart -l app=catalogue -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
          if [ -n "$CATALOGUE_POD" ]; then
            kubectl exec -n metalmart $CATALOGUE_POD -- /bin/sh /app/seed-inventory.sh 2>/dev/null || true
          fi
