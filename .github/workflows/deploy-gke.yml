name: Build and Deploy to GKE

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual trigger

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GKE_CLUSTER: metalmart-cluster
  GKE_ZONE: us-central1-a

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker --quiet

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Build and push catalogue
        run: |
          docker build -t gcr.io/$GCP_PROJECT_ID/metalmart/catalogue:latest services/catalogue/
          docker push gcr.io/$GCP_PROJECT_ID/metalmart/catalogue:latest

      - name: Build and push inventory
        run: |
          docker build -t gcr.io/$GCP_PROJECT_ID/metalmart/inventory:latest services/inventory/
          docker push gcr.io/$GCP_PROJECT_ID/metalmart/inventory:latest

      - name: Build and push checkout
        run: |
          docker build -t gcr.io/$GCP_PROJECT_ID/metalmart/checkout:latest services/checkout/
          docker push gcr.io/$GCP_PROJECT_ID/metalmart/checkout:latest

      - name: Build and push order
        run: |
          docker build -t gcr.io/$GCP_PROJECT_ID/metalmart/order:latest services/order/
          docker push gcr.io/$GCP_PROJECT_ID/metalmart/order:latest

      - name: Build and push order-processor
        run: |
          docker build -t gcr.io/$GCP_PROJECT_ID/metalmart/order-processor:latest services/order-processor/
          docker push gcr.io/$GCP_PROJECT_ID/metalmart/order-processor:latest

      - name: Build and push frontend
        run: |
          docker build -t gcr.io/$GCP_PROJECT_ID/metalmart/frontend:latest frontend/
          docker push gcr.io/$GCP_PROJECT_ID/metalmart/frontend:latest

      - name: Update kustomization with project ID
        run: |
          sed -i "s/PROJECT_ID/$GCP_PROJECT_ID/g" k8s/overlays/gke/kustomization.yaml

      - name: Commit kustomization changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add k8s/overlays/gke/kustomization.yaml
          git commit -m "chore: update GKE kustomization with project ID [skip ci]" || exit 0
          git push || exit 0

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure kubectl
        run: |
          gcloud container clusters get-credentials $GKE_CLUSTER \
            --zone $GKE_ZONE \
            --project $GCP_PROJECT_ID

      - name: Deploy infrastructure
        run: |
          kubectl apply -f k8s/base/namespace.yaml
          kubectl apply -f k8s/base/infrastructure/secrets.yaml
          kubectl apply -f k8s/base/infrastructure/postgres.yaml
          kubectl apply -f k8s/base/infrastructure/kafka.yaml

      - name: Wait for infrastructure
        run: |
          kubectl wait --for=condition=ready pod -l app=postgres -n metalmart --timeout=180s || true
          kubectl wait --for=condition=ready pod -l app=zookeeper -n metalmart --timeout=180s || true
          kubectl wait --for=condition=ready pod -l app=kafka -n metalmart --timeout=180s || true

      - name: Deploy application services
        run: |
          kubectl kustomize k8s/overlays/gke | kubectl apply -f -

      - name: Enable demo mode
        run: |
          kubectl set env deployment/order-processor -n metalmart DEMO_MODE=true || true

      - name: Seed inventory
        run: |
          sleep 10
          CATALOGUE_POD=$(kubectl get pod -n metalmart -l app=catalogue -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
          if [ -n "$CATALOGUE_POD" ]; then
            kubectl exec -n metalmart $CATALOGUE_POD -- /bin/sh /app/seed-inventory.sh 2>/dev/null || true
          fi
