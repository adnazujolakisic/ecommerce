name: Build and Deploy to GKE

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual trigger

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GKE_CLUSTER: metalmart-cluster
  GKE_ZONE: us-central1-a
  AR_LOCATION: us
  AR_REPOSITORY: metalmart

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      catalogue: ${{ steps.filter.outputs.catalogue }}
      inventory: ${{ steps.filter.outputs.inventory }}
      checkout: ${{ steps.filter.outputs.checkout }}
      order: ${{ steps.filter.outputs.order }}
      order-processor: ${{ steps.filter.outputs.order-processor }}
      frontend: ${{ steps.filter.outputs.frontend }}
      k8s: ${{ steps.filter.outputs.k8s }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            catalogue:
              - 'services/catalogue/**'
            inventory:
              - 'services/inventory/**'
            checkout:
              - 'services/checkout/**'
            order:
              - 'services/order/**'
            order-processor:
              - 'services/order-processor/**'
            frontend:
              - 'frontend/**'
            k8s:
              - 'k8s/**'

  build-and-push:
    needs: detect-changes
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service:
          - name: catalogue
            path: services/catalogue
          - name: inventory
            path: services/inventory
          - name: checkout
            path: services/checkout
          - name: order
            path: services/order
          - name: order-processor
            path: services/order-processor
          - name: frontend
            path: frontend
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker $AR_LOCATION-docker.pkg.dev --quiet

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Check if ${{ matrix.service.name }} changed
        id: check-changes
        run: |
          SERVICE_NAME="${{ matrix.service.name }}"
          if [ "$SERVICE_NAME" = "catalogue" ]; then
            CHANGED="${{ needs.detect-changes.outputs.catalogue }}"
          elif [ "$SERVICE_NAME" = "inventory" ]; then
            CHANGED="${{ needs.detect-changes.outputs.inventory }}"
          elif [ "$SERVICE_NAME" = "checkout" ]; then
            CHANGED="${{ needs.detect-changes.outputs.checkout }}"
          elif [ "$SERVICE_NAME" = "order" ]; then
            CHANGED="${{ needs.detect-changes.outputs.order }}"
          elif [ "$SERVICE_NAME" = "order-processor" ]; then
            CHANGED="${{ needs.detect-changes.outputs.order-processor }}"
          elif [ "$SERVICE_NAME" = "frontend" ]; then
            CHANGED="${{ needs.detect-changes.outputs.frontend }}"
          fi
          
          if [ "$CHANGED" = "true" ] || [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
          else
            echo "should_build=false" >> $GITHUB_OUTPUT
          fi

      - name: Build and push ${{ matrix.service.name }}
        if: steps.check-changes.outputs.should_build == 'true'
        run: |
          echo "Building ${{ matrix.service.name }}..."
          docker buildx build \
            --platform linux/amd64 \
            --tag $AR_LOCATION-docker.pkg.dev/$GCP_PROJECT_ID/$AR_REPOSITORY/${{ matrix.service.name }}:latest \
            --push \
            --cache-from type=registry,ref=$AR_LOCATION-docker.pkg.dev/$GCP_PROJECT_ID/$AR_REPOSITORY/${{ matrix.service.name }}:latest \
            ${{ matrix.service.path }}/

      - name: Skip ${{ matrix.service.name }} (no changes)
        if: steps.check-changes.outputs.should_build != 'true'
        run: echo "⏭️  Skipping ${{ matrix.service.name }} - no changes detected"

      - name: Update kustomization with project ID
        run: |
          if grep -q "PROJECT_ID" k8s/overlays/gke/kustomization.yaml; then
            sed -i "s/PROJECT_ID/$GCP_PROJECT_ID/g" k8s/overlays/gke/kustomization.yaml
            echo "✅ Updated kustomization.yaml with project ID"
          else
            echo "⚠️  PROJECT_ID already replaced or not found, skipping"
          fi

      - name: Commit kustomization changes
        if: env.GCP_PROJECT_ID != ''
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add k8s/overlays/gke/kustomization.yaml || true
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update GKE kustomization with project ID [skip ci]" || true
            git push || true
          fi

  deploy:
    needs: [build-and-push, detect-changes]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Install gke-gcloud-auth-plugin
        run: |
          gcloud components install gke-gcloud-auth-plugin --quiet

      - name: Configure kubectl
        run: |
          gcloud container clusters get-credentials $GKE_CLUSTER \
            --zone $GKE_ZONE \
            --project $GCP_PROJECT_ID || {
              echo "❌ Failed to get cluster credentials"
              echo "Make sure cluster '$GKE_CLUSTER' exists in zone '$GKE_ZONE'"
              exit 1
            }

      - name: Deploy infrastructure
        run: |
          kubectl apply -f k8s/base/namespace.yaml
          kubectl apply -f k8s/base/infrastructure/secrets.yaml
          
          # Apply postgres resources separately to handle PVC immutability
          # Extract and apply deployment, service, and configmap (skip PVC)
          kubectl apply -f k8s/base/infrastructure/postgres.yaml --dry-run=client -o yaml | \
            grep -v "kind: PersistentVolumeClaim" | \
            kubectl apply -f - || true
          
          # Handle PVC separately - only create if it doesn't exist
          if ! kubectl get pvc postgres-pvc -n metalmart &>/dev/null; then
            echo "Creating postgres-pvc..."
            kubectl apply -f - <<EOF
          apiVersion: v1
          kind: PersistentVolumeClaim
          metadata:
            name: postgres-pvc
            namespace: metalmart
          spec:
            accessModes:
              - ReadWriteOnce
            storageClassName: standard-rwo
            resources:
              requests:
                storage: 1Gi
          EOF
          else
            echo "✅ PVC postgres-pvc already exists, skipping (immutable)"
          fi
          
          kubectl apply -f k8s/base/infrastructure/kafka.yaml

      - name: Wait for infrastructure
        run: |
          kubectl wait --for=condition=ready pod -l app=postgres -n metalmart --timeout=180s || true
          kubectl wait --for=condition=ready pod -l app=zookeeper -n metalmart --timeout=180s || true
          kubectl wait --for=condition=ready pod -l app=kafka -n metalmart --timeout=180s || true

      - name: Update kustomization with project ID (deploy job)
        run: |
          if grep -q "PROJECT_ID" k8s/overlays/gke/kustomization.yaml; then
            sed -i "s/PROJECT_ID/$GCP_PROJECT_ID/g" k8s/overlays/gke/kustomization.yaml
          fi

      - name: Deploy application services
        run: |
          kubectl kustomize k8s/overlays/gke | kubectl apply -f - || {
            echo "❌ Failed to deploy services"
            echo "Checking kustomization..."
            kubectl kustomize k8s/overlays/gke
            exit 1
          }

      - name: Enable demo mode
        run: |
          kubectl set env deployment/order-processor -n metalmart DEMO_MODE=true || true

      - name: Seed inventory
        run: |
          sleep 10
          CATALOGUE_POD=$(kubectl get pod -n metalmart -l app=catalogue -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
          if [ -n "$CATALOGUE_POD" ]; then
            kubectl exec -n metalmart $CATALOGUE_POD -- /bin/sh /app/seed-inventory.sh 2>/dev/null || true
          fi
